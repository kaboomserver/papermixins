package pw.kaboom.papermixins.mixin.fix.exploit.oversized_component;

import net.minecraft.network.protocol.Packet;
import net.minecraft.network.protocol.game.ClientboundBossEventPacket;
import net.minecraft.world.BossEvent;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Unique;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;
import pw.kaboom.papermixins.duck.PacketFallbackExtension;
import pw.kaboom.papermixins.util.FakeBossEvent;

@Mixin(ClientboundBossEventPacket.class)
public abstract class ClientboundBossEventPacketMixin implements PacketFallbackExtension {
    @Unique
    private BossEvent papermixins$event;

    @Inject(method = "createAddPacket", at = @At(value = "RETURN"))
    private static void createAddPacket(final BossEvent event,
                                        final CallbackInfoReturnable<ClientboundBossEventPacket> cir) {
        final ClientboundBossEventPacket packet = cir.getReturnValue();
        ((ClientboundBossEventPacketMixin) (Object) packet).papermixins$event = event;
    }

    @Override
    public Packet<?> papermixins$getFallback() {
        if (this.papermixins$event == null) return null;

        final FakeBossEvent fake = FakeBossEvent.cloneWithoutName(papermixins$event);
        return ClientboundBossEventPacket.createAddPacket(fake);
    }
}
