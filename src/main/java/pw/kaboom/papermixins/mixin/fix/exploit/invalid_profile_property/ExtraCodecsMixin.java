package pw.kaboom.papermixins.mixin.fix.exploit.invalid_profile_property;

import com.llamalad7.mixinextras.injector.wrapoperation.Operation;
import com.llamalad7.mixinextras.injector.wrapoperation.WrapOperation;
import com.mojang.serialization.Codec;
import com.mojang.serialization.MapCodec;
import com.mojang.serialization.codecs.PrimitiveCodec;
import net.minecraft.util.ExtraCodecs;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;

@Mixin(ExtraCodecs.class)
public abstract class ExtraCodecsMixin {
    // limits from ByteBufCodecs#GAME_PROFILE_PROPERTIES
    @WrapOperation(method = "lambda$static$44",
        at = @At(value = "INVOKE", target = "Lcom/mojang/serialization/codecs/PrimitiveCodec;fieldOf" +
            "(Ljava/lang/String;)Lcom/mojang/serialization/MapCodec;", ordinal = 0, remap = false))
    private static MapCodec<?> property$fieldOfName(final PrimitiveCodec<?> instance, final String name,
                                                    final Operation<?> original) {
        return Codec.string(0, 64).fieldOf(name);
    }

    @WrapOperation(method = "lambda$static$44",
        at = @At(value = "INVOKE", target = "Lcom/mojang/serialization/codecs/PrimitiveCodec;fieldOf" +
            "(Ljava/lang/String;)Lcom/mojang/serialization/MapCodec;", ordinal = 1, remap = false))
    private static MapCodec<?> property$fieldOfValue(final PrimitiveCodec<?> instance, final String name,
                                                     final Operation<?> original) {
        return Codec.string(0, 32767).fieldOf(name);
    }

    @WrapOperation(method = "lambda$static$44",
        at = @At(value = "INVOKE", target = "Lcom/mojang/serialization/codecs/PrimitiveCodec;lenientOptionalFieldOf" +
            "(Ljava/lang/String;)Lcom/mojang/serialization/MapCodec;", remap = false))
    private static MapCodec<?> property$fieldOfSignature(final PrimitiveCodec<?> instance, final String name,
                                                         final Operation<?> original) {
        return Codec.string(0, 1024).lenientOptionalFieldOf(name);
    }
}